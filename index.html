<!DOCTYPE html>
<html lang="sv">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Wild Gunman Clone</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap");

      /* NES Färgpalett & Layout */
      body {
        background-color: #000;
        color: white;
        font-family: "Press Start 2P", cursive;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        overflow: hidden;
        user-select: none;
        -webkit-user-select: none; /* För Safari */
        touch-action: none; /* Förhindra zoom/scroll gester */
      }

      #game-container {
        position: relative;

        /* --- MOBILANPASSNING START --- */
        width: 95%;
        max-width: 768px;
        aspect-ratio: 256/224;
        max-height: 90vh;
        /* --- MOBILANPASSNING SLUT --- */

        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        background: #000;
        margin: auto;
      }

      canvas {
        display: block;
        width: 100%;
        height: 100%;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
      }

      /* --- SCANLINES (CRT EFFECT) --- */
      .scanlines {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0),
          rgba(255, 255, 255, 0) 50%,
          rgba(0, 0, 0, 0.3) 50%,
          rgba(0, 0, 0, 0.3)
        );
        background-size: 100% 4px;
        pointer-events: none;
        z-index: 100;
      }

      /* --- UI LAGER --- */
      .ui-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 60;
      }

      /* --- HUD --- */
      #hud {
        display: none;
        width: 100%;
        height: 100%;
        flex-direction: column;
        justify-content: space-between;
      }

      .hud-bar {
        background: #000;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #adff2f;
        font-size: 16px;
        text-transform: uppercase;
        padding: 2% 4%;
        box-sizing: border-box;
        border-bottom: 4px solid #000;
        position: absolute;
        left: 0;
        z-index: 70;
      }

      .hud-top {
        top: 0;
        border-bottom: 4px solid #fff;
      }

      .hud-bottom {
        bottom: 0;
        border-top: 4px solid #fff;
      }

      .hud-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 15%;
      }

      .hud-label {
        background: #000;
        border: 2px solid #adff2f;
        padding: 2px 5px;
        font-size: 10px;
        margin-bottom: 5px;
        white-space: nowrap;
      }

      .hud-value {
        font-size: 20px;
        letter-spacing: 2px;
      }

      /* --- START SKÄRM --- */
      #start-screen {
        background-color: #000;
        pointer-events: auto;
        z-index: 80;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 10%;
      }

      .logo-main {
        font-size: 50px;
        color: #d85040;
        text-shadow: 4px 4px 0 #000;
        margin-bottom: 8%;
        letter-spacing: 5px;
        transform: scaleY(1.2);
        text-align: center;
        line-height: 1.5;
      }

      .menu-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        width: 100%;
        align-items: center;
      }

      .menu-row {
        display: flex;
        gap: 20px;
        font-size: 18px;
        cursor: pointer;
        width: 80%;
        max-width: 450px;
        justify-content: center;
      }

      .menu-label {
        color: #5c94fc;
        width: 120px;
        text-align: left;
      }

      .menu-desc {
        color: #fff;
        flex: 1;
        text-align: left;
      }

      @media (hover: hover) {
        .menu-row:hover .menu-label::before {
          content: "►";
          color: #fff;
          position: absolute;
          margin-left: -25px;
        }
      }

      .footer-info {
        margin-top: auto;
        margin-bottom: 5%;
        text-align: center;
        font-size: 12px;
        line-height: 2;
      }

      .copyright {
        color: #d8ac50;
      }

      @media (max-width: 600px) {
        .logo-main {
          font-size: 28px;
          letter-spacing: 2px;
        }
        .menu-row {
          font-size: 12px;
          gap: 10px;
        }
        .menu-label {
          width: 80px;
        }
        .hud-value {
          font-size: 12px;
        }
        .hud-label {
          font-size: 8px;
          padding: 1px 3px;
          border-width: 1px;
        }
        .footer-info {
          font-size: 8px;
        }
        .big-msg {
          font-size: 20px;
          padding: 10px 15px;
        }
      }

      /* --- SPELMEDDELANDEN --- */
      #message-overlay {
        position: absolute;
        top: 25%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        display: none;
        z-index: 90;
        width: 100%;
        pointer-events: none;
      }

      .big-msg {
        font-size: 30px;
        color: #fff;
        text-shadow: 3px 3px #000;
        background: #000;
        padding: 15px 25px;
        border: 4px solid #fff;
        display: inline-block;
      }

      .flash {
        background: white;
        opacity: 0;
        transition: opacity 0.05s;
      }
    </style>
  </head>
  <body>
    <div id="game-container">
      <!-- SCANLINES -->
      <div class="scanlines"></div>

      <!-- HUD -->
      <div id="hud-top" class="hud-bar hud-top" style="display: none">
        <div class="hud-group">
          <div class="hud-value" id="ui-time">0.00</div>
        </div>
        <div class="hud-group">
          <div class="hud-label">TIME</div>
          <div class="hud-label">GUNMAN</div>
        </div>
        <div class="hud-group">
          <div class="hud-value" id="ui-limit">0.00</div>
        </div>
      </div>

      <canvas id="gameCanvas" width="256" height="224"></canvas>

      <div id="hud-bottom" class="hud-bar hud-bottom" style="display: none">
        <div class="hud-group" style="align-items: flex-start">
          <div class="hud-value" style="color: #adff2f">
            $<span id="ui-reward">0</span>
          </div>
          <div style="font-size: 8px">REWARD</div>
        </div>
        <div class="hud-group">
          <div class="hud-value" id="ui-score">000000</div>
          <div style="font-size: 8px">SCORE</div>
        </div>
        <div class="hud-group" style="align-items: flex-end">
          <div class="hud-value" id="ui-level">1</div>
          <div style="font-size: 8px">LEVEL</div>
        </div>
      </div>

      <!-- MENU -->
      <div id="start-screen" class="ui-layer">
        <div class="logo-main">WILD<br />GUNMAN</div>

        <div class="menu-container">
          <div
            class="menu-row"
            onclick="startGame('A')"
            ontouchstart="startGame('A')"
          >
            <div class="menu-label">GAME A</div>
            <div class="menu-desc">1 OUTLAW</div>
          </div>
          <div
            class="menu-row"
            onclick="startGame('B')"
            ontouchstart="startGame('B')"
          >
            <div class="menu-label">GAME B</div>
            <div class="menu-desc">2 OUTLAWS</div>
          </div>
          <div
            class="menu-row"
            onclick="startGame('C')"
            ontouchstart="startGame('C')"
          >
            <div class="menu-label">GAME C</div>
            <div class="menu-desc">GANG</div>
          </div>
        </div>

        <div class="footer-info">
          <div style="color: white; margin-bottom: 10px">TOP SCORE - 12000</div>
          <div class="copyright">©1984 NINTENDO CO.,LTD.</div>
          <div class="copyright">MADE IN JAPAN</div>
        </div>
      </div>

      <!-- MEDDELANDEN -->
      <div id="message-overlay">
        <div id="game-msg" class="big-msg">FIRE!</div>
      </div>

      <div id="flash-effect" class="ui-layer flash"></div>
    </div>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");

      // Spelvariabler
      let gameState = "MENU";
      let gameMode = "A";
      let level = 1;
      let score = 0;
      let reward = 500;

      let waitTimer = 0;
      let drawTimer = 0;
      let reactionLimit = 1000;
      let enemies = [];
      let playerReactionTime = 0;

      let inputLockTimer = 0;

      // --- AUDIO ---
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      function playSound(type) {
        if (audioCtx.state === "suspended") audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const t = audioCtx.currentTime;

        if (type === "fire") {
          osc.type = "square";
          osc.frequency.setValueAtTime(150, t);
          osc.frequency.exponentialRampToValueAtTime(40, t + 0.1);
          gain.gain.setValueAtTime(0.3, t);
          gain.gain.linearRampToValueAtTime(0, t + 0.1);
          osc.start();
          osc.stop(t + 0.1);
        } else if (type === "cue") {
          osc.type = "triangle";
          osc.frequency.setValueAtTime(880, t);
          gain.gain.setValueAtTime(0.1, t);
          gain.gain.linearRampToValueAtTime(0, t + 0.1);
          osc.start();
          osc.stop(t + 0.1);
        } else if (type === "shot") {
          osc.type = "sawtooth";
          osc.frequency.setValueAtTime(1200, t);
          osc.frequency.exponentialRampToValueAtTime(100, t + 0.15);
          gain.gain.setValueAtTime(0.4, t);
          gain.gain.linearRampToValueAtTime(0, t + 0.15);
          osc.start();
          osc.stop(t + 0.15);
        } else if (type === "win") {
          osc.type = "square";
          osc.frequency.setValueAtTime(523, t);
          osc.frequency.setValueAtTime(659, t + 0.08);
          osc.frequency.setValueAtTime(784, t + 0.16);
          osc.frequency.setValueAtTime(1046, t + 0.24);
          gain.gain.value = 0.1;
          osc.start();
          osc.stop(t + 0.4);
        }
      }

      // --- ENTITIES ---
      function createEnemy(type, startX, targetX) {
        return {
          type: type, // 0 = Standard, 1 = Kort, 2 = Poncho
          x: startX,
          y: 110, // Default för Game A/B
          w: 24,
          h: 48,
          targetX: targetX,
          frame: 0,
          state: "WALK",
          timer: 0,
          scale: 1.0, // För animation
        };
      }

      // --- LOGIK ---
      function startGame(mode) {
        if (gameState !== "MENU") return;

        gameMode = mode;
        gameState = "WALK_IN";
        score = 0;
        level = 1;
        reward = 500;

        document.getElementById("start-screen").style.display = "none";
        document.getElementById("hud-top").style.display = "flex";
        document.getElementById("hud-bottom").style.display = "flex";

        if (audioCtx.state === "suspended") audioCtx.resume();

        resetRound();
      }

      function resetRound() {
        gameState = "WALK_IN";
        document.getElementById("message-overlay").style.display = "none";
        playerReactionTime = 0;
        updateUI();

        inputLockTimer = Date.now() + 500;

        enemies = [];

        let baseReaction = 1000 - level * 50;
        if (baseReaction < 400) baseReaction = 400;
        reactionLimit = baseReaction;

        if (gameMode === "A") {
          // Game A: Ensam outlaw (Slumpmässig typ)
          const type = Math.floor(Math.random() * 3);
          enemies.push(createEnemy(type, -30, 116));
        } else if (gameMode === "B") {
          // Game B: Två outlaws (Olika typer)
          reactionLimit += 200;
          enemies.push(createEnemy(1, -30, 70)); // Kort från vänster
          enemies.push(createEnemy(2, 280, 160)); // Poncho från höger
        } else if (gameMode === "C") {
          gameState = "WAIT";
          waitTimer = Date.now() + (Math.random() * 2000 + 1000);

          reactionLimit = Math.max(500, 1200 - level * 60);

          const count = Math.random() > 0.6 || level > 5 ? 2 : 1;

          const positions = [
            { x: 45, y: 45 }, // Fönster V Uppe
            { x: 180, y: 45 }, // Fönster H Uppe
            { x: 45, y: 115 }, // Fönster V Nere
            { x: 180, y: 115 }, // Fönster H Nere
            { x: 116, y: 115 }, // Dörr
          ];

          positions.sort(() => Math.random() - 0.5);

          for (let i = 0; i < count; i++) {
            const pos = positions[i];
            const type = Math.floor(Math.random() * 3); // Slumpmässig gubbe i fönstret
            let e = createEnemy(type, pos.x, pos.x);
            e.y = pos.y;
            e.state = "IDLE";
            enemies.push(e);
          }
        }
      }

      function update() {
        const now = Date.now();

        // --- ANIMERA FALL BAKÅT FÖR GAME C ---
        if (gameMode === "C") {
          enemies.forEach((e) => {
            if (e.state === "DEAD") {
              if (e.scale > 0) {
                e.scale -= 0.05;
                if (e.scale < 0) e.scale = 0;
              }
            }
          });
        }

        if (gameState === "WALK_IN") {
          let allArrived = true;
          enemies.forEach((e) => {
            if (Math.abs(e.x - e.targetX) > 1.5) {
              e.x += e.x < e.targetX ? 1.5 : -1.5;
              allArrived = false;
              if (now % 200 > 100) e.frame = 1;
              else e.frame = 0;
            } else {
              e.frame = 0;
              e.state = "IDLE";
            }
          });

          if (allArrived) {
            gameState = "WAIT";
            waitTimer = now + (Math.random() * 2000 + 1000);
          }
        } else if (gameState === "WAIT") {
          if (now > waitTimer) {
            gameState = "DRAW";
            drawTimer = now;
            playSound("cue");
            const msg = document.getElementById("game-msg");
            msg.innerText = "FIRE!";
            msg.style.color = "#d85040";
            msg.style.borderColor = "#d85040";
            document.getElementById("message-overlay").style.display = "block";
          }
        } else if (gameState === "DRAW") {
          let elapsed = now - drawTimer;
          document.getElementById("ui-time").innerText = (
            elapsed / 1000
          ).toFixed(2);

          let livingEnemies = enemies.filter((e) => e.state !== "DEAD");
          if (livingEnemies.length > 0 && elapsed > reactionLimit) {
            playerLost();
          }
        }
      }

      function handleInput(x, y) {
        if (Date.now() < inputLockTimer) return;

        if (gameState === "WALK_IN") {
          return;
        }

        if (gameState === "WAIT") {
          gameState = "END";
          const msg = document.getElementById("game-msg");
          msg.innerText = "FOUL!";
          msg.style.color = "#d8ac50";
          msg.style.borderColor = "#d8ac50";
          document.getElementById("message-overlay").style.display = "block";
          playSound("fire");
          setTimeout(() => {
            resetRound();
          }, 2000);
          return;
        }

        if (gameState === "DRAW") {
          playSound("shot");
          flashScreen();

          let hitAny = false;
          enemies.forEach((e) => {
            if (e.state !== "DEAD") {
              // Generösare hitbox för touch
              if (
                x >= e.x - 15 &&
                x <= e.x + e.w + 15 &&
                y >= e.y - 25 &&
                y <= e.y + e.h + 25
              ) {
                e.state = "DEAD";
                hitAny = true;
              }
            }
          });

          if (enemies.every((e) => e.state === "DEAD")) {
            playerReactionTime = Date.now() - drawTimer;
            playerWon();
          }
        }
      }

      function playerWon() {
        gameState = "END";
        playSound("win");
        document.getElementById("message-overlay").style.display = "none";

        let points = Math.max(100, 2000 - playerReactionTime);
        score += points;
        reward += 100;
        level++;
        updateUI();

        setTimeout(resetRound, 3000);
      }

      function playerLost() {
        gameState = "END";
        playSound("fire");
        enemies.forEach((e) => {
          if (e.state !== "DEAD") e.state = "FIRE";
        });

        const msg = document.getElementById("game-msg");
        msg.innerText = "YOU LOST";
        msg.style.color = "white";
        msg.style.borderColor = "white";
        document.getElementById("message-overlay").style.display = "block";

        setTimeout(() => {
          document.getElementById("start-screen").style.display = "flex";
          document.getElementById("hud-top").style.display = "none";
          document.getElementById("hud-bottom").style.display = "none";
          document.getElementById("message-overlay").style.display = "none";
          gameState = "MENU";
        }, 3000);
      }

      function updateUI() {
        document.getElementById("ui-score").innerText = score
          .toString()
          .padStart(6, "0");
        document.getElementById("ui-reward").innerText = reward;
        document.getElementById("ui-level").innerText = level;
        document.getElementById("ui-limit").innerText = (
          reactionLimit / 1000
        ).toFixed(2);
      }

      function flashScreen() {
        const el = document.getElementById("flash-effect");
        el.style.opacity = 0.8;
        setTimeout(() => (el.style.opacity = 0), 50);
      }

      // --- RITNING ---
      function draw() {
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (gameMode === "C") {
          drawSaloon();
        } else {
          drawDesert();
        }

        // Rita fiender (Sortera så att de längre fram ritas sist)
        // Men i 2D utan djup spelar det mindre roll, men bra praxis
        enemies.forEach((e) => drawEnemy(e));
      }

      function drawDesert() {
        ctx.fillStyle = "#202090"; // Himmel
        ctx.fillRect(0, 0, canvas.width, 140);
        ctx.fillStyle = "#a88440"; // Mark
        ctx.fillRect(0, 140, canvas.width, 84);

        drawScenery();
      }

      function drawSaloon() {
        // Bakgrundsfärg (om något syns bakom)
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Saloon vägg
        ctx.fillStyle = "#e08070";
        ctx.fillRect(10, 10, 236, 204);

        // Detaljer
        ctx.fillStyle = "#b05040";
        for (let y = 20; y < 214; y += 10) {
          ctx.fillRect(10, y, 236, 1);
        }

        // Fönster & Dörr (Svarta hål)
        ctx.fillStyle = "#000";

        // Fönster uppe
        ctx.fillRect(40, 40, 34, 58);
        ctx.fillRect(175, 40, 34, 58);

        // Fönster nere
        ctx.fillRect(40, 110, 34, 58);
        ctx.fillRect(175, 110, 34, 58);

        // Dörr
        ctx.fillRect(108, 110, 40, 104);

        // Skylt
        ctx.fillStyle = "#603010";
        ctx.fillRect(90, 70, 76, 20);
        ctx.fillStyle = "#fff";
        ctx.font = "8px 'Press Start 2P'";
        ctx.fillText("SALOON", 100, 84);
      }

      function drawScenery() {
        ctx.fillStyle = "#603030";
        ctx.beginPath();
        ctx.moveTo(20, 140);
        ctx.lineTo(60, 60);
        ctx.lineTo(100, 140);
        ctx.fill();

        drawCactus(110, 130, 1);
        drawCactus(220, 135, 0.8);
      }

      function drawCactus(x, y, s) {
        ctx.fillStyle = "#389030";
        const w = Math.floor(6 * s);
        const h = Math.floor(25 * s);
        ctx.fillRect(x, y - h, w, h);
        ctx.fillRect(x - w, y - h / 2, w, w);
        ctx.fillRect(x - w, y - h / 1.5, 2, w * 2);
        ctx.fillRect(x + w, y - h / 2.5, w, w);
        ctx.fillRect(x + w * 1.5, y - h / 1.8, 2, w * 2);
      }

      function drawEnemy(e) {
        ctx.save();
        ctx.translate(Math.floor(e.x), Math.floor(e.y));

        // --- SPEL C: FALLA BAKÅT (Skala ner mot mitten) ---
        if (gameMode === "C" && e.state === "DEAD") {
          ctx.translate(12, 24);
          ctx.scale(e.scale, e.scale);
          ctx.translate(-12, -24);
        }
        // --- SPEL A/B: RAMLA SIDA ---
        else if (e.state === "DEAD") {
          ctx.rotate(Math.PI / 2);
          ctx.translate(0, -16);
        }

        // Skugga vid död i Game C
        let shadow = gameMode === "C" && e.state === "DEAD";

        if (e.type === 0) drawStandard(e, shadow);
        else if (e.type === 1) drawShort(e, shadow);
        else if (e.type === 2) drawPoncho(e, shadow);

        ctx.restore();
      }

      // --- RITNING AV OLIKA TYPER ---

      function drawStandard(e, shadow) {
        let cSkin = shadow ? "#805030" : "#f8b880";
        let cVest = shadow ? "#500000" : "#a00000";
        let cPants = shadow ? "#101060" : "#3030b0";
        let cHat = shadow ? "#808080" : "#d0d0d0";
        let cShirt = shadow ? "#808080" : "#fff";

        if (e.state === "WALK") {
          // Profil (Går)
          const facingRight = e.targetX > e.x;
          if (!facingRight) {
            ctx.translate(24, 0);
            ctx.scale(-1, 1);
          }

          // Ben
          ctx.fillStyle = cPants;
          if (e.frame === 0) {
            ctx.fillRect(8, 30, 6, 18);
            ctx.fillRect(2, 28, 6, 16);
          } else {
            ctx.fillRect(6, 30, 6, 18);
            ctx.fillRect(14, 28, 6, 16);
          }
          // Kropp
          ctx.fillStyle = cShirt;
          ctx.fillRect(8, 12, 10, 18);
          ctx.fillStyle = cVest;
          ctx.fillRect(8, 12, 6, 18);
          // Huvud
          ctx.fillStyle = cSkin;
          ctx.fillRect(8, 2, 9, 10);
          // Hatt
          ctx.fillStyle = cHat;
          ctx.fillRect(4, 0, 16, 2);
          ctx.fillRect(8, -4, 10, 4);
          // Arm
          ctx.fillStyle = cShirt;
          if (e.frame === 0) ctx.fillRect(10, 14, 4, 14);
          else ctx.fillRect(12, 12, 4, 14);
        } else {
          // Framifrån (Idle/Fire/Dead)
          ctx.fillStyle = cPants;
          ctx.fillRect(4, 30, 6, 18);
          ctx.fillRect(14, 30, 6, 18);

          ctx.fillStyle = cShirt;
          ctx.fillRect(4, 12, 16, 18);
          ctx.fillStyle = cVest;
          ctx.fillRect(4, 12, 4, 18);
          ctx.fillRect(16, 12, 4, 18);

          ctx.fillStyle = cSkin;
          ctx.fillRect(7, 2, 10, 10);

          ctx.fillStyle = "#000";
          if (e.state === "DEAD") {
            ctx.fillRect(8, 5, 2, 1);
            ctx.fillRect(13, 5, 2, 1);
            ctx.fillRect(9, 9, 5, 2);
          } else {
            ctx.fillRect(8, 4, 2, 2);
            ctx.fillRect(13, 4, 2, 2);
            ctx.fillRect(9, 9, 5, 1);
          }

          ctx.fillStyle = cHat;
          ctx.fillRect(2, 0, 20, 2);
          ctx.fillRect(6, -4, 12, 4);

          if (e.state === "FIRE") {
            ctx.fillStyle = cShirt;
            ctx.fillRect(20, 12, 8, 4);
            ctx.fillStyle = "#000";
            ctx.fillRect(28, 10, 6, 4); // Pistol
            if (Math.random() > 0.5) {
              ctx.fillStyle = "#ff0";
              ctx.fillRect(34, 9, 6, 6);
            }
          } else {
            ctx.fillStyle = cShirt;
            ctx.fillRect(0, 12, 4, 14);
            ctx.fillRect(20, 12, 4, 14);
          }
        }
      }

      function drawShort(e, shadow) {
        let cSkin = shadow ? "#806040" : "#f8c8a0";
        let cVest = shadow ? "#303030" : "#505050";
        let cPants = shadow ? "#101010" : "#202020";
        let cHat = shadow ? "#302010" : "#604020";
        let cShirt = shadow ? "#602020" : "#c04040";

        // Kortare och bredare
        if (e.state === "WALK") {
          const facingRight = e.targetX > e.x;
          if (!facingRight) {
            ctx.translate(24, 0);
            ctx.scale(-1, 1);
          }

          // Korta ben
          ctx.fillStyle = cPants;
          if (e.frame === 0) {
            ctx.fillRect(6, 38, 6, 10);
            ctx.fillRect(0, 36, 6, 10);
          } else {
            ctx.fillRect(4, 38, 6, 10);
            ctx.fillRect(12, 36, 6, 10);
          }

          // Bred kropp
          ctx.fillStyle = cShirt;
          ctx.fillRect(4, 18, 14, 20);
          ctx.fillStyle = cVest;
          ctx.fillRect(4, 18, 8, 20);

          // Huvud (Lågt)
          ctx.fillStyle = cSkin;
          ctx.fillRect(6, 8, 10, 10);

          // Stor hatt
          ctx.fillStyle = cHat;
          ctx.fillRect(0, 6, 20, 2);
          ctx.fillRect(4, 2, 14, 4);

          ctx.fillStyle = cShirt;
          ctx.fillRect(8, 22, 4, 10);
        } else {
          ctx.fillStyle = cPants;
          ctx.fillRect(2, 38, 8, 10);
          ctx.fillRect(14, 38, 8, 10);

          ctx.fillStyle = cShirt;
          ctx.fillRect(2, 18, 20, 20);
          ctx.fillStyle = cVest;
          ctx.fillRect(2, 18, 6, 20);
          ctx.fillRect(16, 18, 6, 20);

          ctx.fillStyle = cSkin;
          ctx.fillRect(7, 8, 10, 10);

          ctx.fillStyle = "#000";
          // Mustasch
          ctx.fillRect(8, 15, 8, 2);
          if (e.state !== "DEAD") {
            ctx.fillRect(8, 10, 2, 2);
            ctx.fillRect(14, 10, 2, 2);
          } else {
            ctx.fillRect(8, 11, 2, 1);
            ctx.fillRect(14, 11, 2, 1);
          }

          ctx.fillStyle = cHat;
          ctx.fillRect(0, 6, 24, 2);
          ctx.fillRect(4, 2, 16, 4);

          if (e.state === "FIRE") {
            ctx.fillStyle = cShirt;
            ctx.fillRect(22, 22, 6, 4);
            ctx.fillStyle = "#000";
            ctx.fillRect(28, 20, 6, 4);
            if (Math.random() > 0.5) {
              ctx.fillStyle = "#ff0";
              ctx.fillRect(34, 19, 6, 6);
            }
          } else {
            ctx.fillStyle = cShirt;
            ctx.fillRect(-2, 22, 4, 12);
            ctx.fillRect(22, 22, 4, 12);
          }
        }
      }

      function drawPoncho(e, shadow) {
        let cSkin = shadow ? "#805030" : "#d09060";
        let cPoncho = shadow ? "#405020" : "#80a040"; // Grön poncho
        let cPants = shadow ? "#404040" : "#f0f0f0"; // Vita byxor
        let cHat = shadow ? "#503010" : "#a06020"; // Sombrero

        if (e.state === "WALK") {
          const facingRight = e.targetX > e.x;
          if (!facingRight) {
            ctx.translate(24, 0);
            ctx.scale(-1, 1);
          }

          ctx.fillStyle = cPants;
          if (e.frame === 0) {
            ctx.fillRect(8, 36, 6, 12);
            ctx.fillRect(2, 34, 6, 12);
          } else {
            ctx.fillRect(6, 36, 6, 12);
            ctx.fillRect(14, 34, 6, 12);
          }

          // Poncho (Triangel-ish)
          ctx.fillStyle = cPoncho;
          ctx.beginPath();
          ctx.moveTo(10, 10);
          ctx.lineTo(2, 30);
          ctx.lineTo(18, 30);
          ctx.lineTo(14, 10);
          ctx.fill();

          ctx.fillStyle = cSkin;
          ctx.fillRect(9, 4, 8, 8);

          // Sombrero
          ctx.fillStyle = cHat;
          ctx.fillRect(2, 2, 20, 2);
          ctx.fillRect(8, -2, 8, 4);
        } else {
          ctx.fillStyle = cPants;
          ctx.fillRect(6, 36, 4, 12);
          ctx.fillRect(14, 36, 4, 12);

          // Poncho Fram
          ctx.fillStyle = cPoncho;
          ctx.beginPath();
          ctx.moveTo(12, 10);
          ctx.lineTo(0, 32);
          ctx.lineTo(24, 32);
          ctx.fill();

          ctx.fillStyle = cSkin;
          ctx.fillRect(8, 4, 8, 8);

          ctx.fillStyle = "#000";
          if (e.state !== "DEAD") {
            ctx.fillRect(9, 6, 2, 2);
            ctx.fillRect(13, 6, 2, 2);
          } else {
            ctx.fillRect(9, 7, 2, 1);
            ctx.fillRect(13, 7, 2, 1);
          }

          // Sombrero
          ctx.fillStyle = cHat;
          ctx.fillRect(0, 2, 24, 2);
          ctx.fillRect(8, -2, 8, 4);

          if (e.state === "FIRE") {
            // Arm kommer ut ur ponchon
            ctx.fillStyle = cSkin;
            ctx.fillRect(20, 20, 6, 4);
            ctx.fillStyle = "#000";
            ctx.fillRect(26, 18, 6, 4);
            if (Math.random() > 0.5) {
              ctx.fillStyle = "#ff0";
              ctx.fillRect(32, 17, 6, 6);
            }
          }
        }
      }

      function loop() {
        if (gameState !== "MENU") {
          update();
          draw();
        }
        requestAnimationFrame(loop);
      }
      loop();

      function onInteract(e) {
        if (gameState !== "MENU" && gameState !== "END") {
          e.preventDefault();

          const rect = canvas.getBoundingClientRect();

          let clientX, clientY;
          if (e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
          } else {
            clientX = e.clientX;
            clientY = e.clientY;
          }

          const scaleX = canvas.width / rect.width;
          const scaleY = canvas.height / rect.height;

          const x = (clientX - rect.left) * scaleX;
          const y = (clientY - rect.top) * scaleY;

          handleInput(x, y);
        }
      }

      canvas.addEventListener("mousedown", onInteract);
      canvas.addEventListener("touchstart", onInteract, { passive: false });
    </script>
  </body>
</html>
