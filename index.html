<!DOCTYPE html>
<html lang="sv">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Young Guns - Wild Gunman Clone</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap");

      /* NES Färgpalett & Layout */
      body {
        background-color: #000;
        color: white;
        font-family: "Press Start 2P", cursive;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        overflow: hidden;
        user-select: none;
        -webkit-user-select: none; /* För Safari */
        touch-action: none; /* Förhindra zoom/scroll gester */
      }

      #game-container {
        position: relative;
        width: 95%;
        max-width: 768px;
        aspect-ratio: 256/224;
        max-height: 90vh;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        background: #000;
        margin: auto;
      }

      canvas {
        display: block;
        width: 100%;
        height: 100%;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
      }

      /* --- SCANLINES (CRT EFFECT) --- */
      .scanlines {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0),
          rgba(255, 255, 255, 0) 50%,
          rgba(0, 0, 0, 0.3) 50%,
          rgba(0, 0, 0, 0.3)
        );
        background-size: 100% 4px;
        pointer-events: none;
        z-index: 100;
      }

      /* --- UI LAGER --- */
      .ui-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 60;
      }

      /* --- HUD --- */
      #hud {
        display: none;
        width: 100%;
        height: 100%;
        flex-direction: column;
        justify-content: space-between;
      }

      .hud-bar {
        background: #000;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #adff2f;
        font-size: 16px;
        text-transform: uppercase;
        padding: 2% 4%;
        box-sizing: border-box;
        border-bottom: 4px solid #000;
        position: absolute;
        left: 0;
        z-index: 70;
      }

      .hud-top {
        top: 0;
        border-bottom: 4px solid #fff;
      }

      .hud-bottom {
        bottom: 0;
        border-top: 4px solid #fff;
      }

      .hud-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 15%;
      }

      .hud-label {
        background: #000;
        border: 2px solid #adff2f;
        padding: 2px 5px;
        font-size: 10px;
        margin-bottom: 5px;
        white-space: nowrap;
      }

      .hud-value {
        font-size: 20px;
        letter-spacing: 2px;
      }

      /* --- START SKÄRM --- */
      #start-screen {
        background-color: #000;
        pointer-events: auto;
        z-index: 80;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 10%;
      }

      .logo-main {
        font-size: 50px;
        color: #d85040;
        text-shadow: 4px 4px 0 #000;
        margin-bottom: 8%;
        letter-spacing: 5px;
        transform: scaleY(1.2);
        text-align: center;
        line-height: 1.5;
      }

      .menu-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        width: 100%;
        align-items: center;
      }

      .menu-row {
        display: flex;
        gap: 20px;
        font-size: 18px;
        cursor: pointer;
        width: 80%;
        max-width: 450px;
        justify-content: center;
      }

      .menu-label {
        color: #5c94fc;
        width: 120px;
        text-align: left;
      }

      .menu-desc {
        color: #fff;
        flex: 1;
        text-align: left;
      }

      @media (hover: hover) {
        .menu-row:hover .menu-label::before {
          content: "►";
          color: #fff;
          position: absolute;
          margin-left: -25px;
        }
      }

      .footer-info {
        margin-top: auto;
        margin-bottom: 5%;
        text-align: center;
        font-size: 12px;
        line-height: 2;
      }

      .copyright {
        color: #d8ac50;
      }

      @media (max-width: 600px) {
        .logo-main {
          font-size: 28px;
          letter-spacing: 2px;
        }
        .menu-row {
          font-size: 12px;
          gap: 10px;
        }
        .menu-label {
          width: 80px;
        }
        .hud-value {
          font-size: 12px;
        }
        .hud-label {
          font-size: 8px;
          padding: 1px 3px;
          border-width: 1px;
        }
        .footer-info {
          font-size: 8px;
        }
        .big-msg {
          font-size: 20px;
          padding: 10px 15px;
        }
      }

      /* --- SPELMEDDELANDEN --- */
      #message-overlay {
        position: absolute;
        top: 25%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        display: none;
        z-index: 90;
        width: 100%;
        pointer-events: none;
      }

      .big-msg {
        font-size: 30px;
        color: #fff;
        text-shadow: 3px 3px #000;
        background: #000;
        padding: 15px 25px;
        border: 4px solid #fff;
        display: inline-block;
      }

      .flash {
        background: white;
        opacity: 0;
        transition: opacity 0.05s;
      }
    </style>
  </head>
  <body>
    <div id="game-container">
      <!-- SCANLINES -->
      <div class="scanlines"></div>

      <!-- HUD -->
      <div id="hud-top" class="hud-bar hud-top" style="display: none">
        <div class="hud-group">
          <div class="hud-value" id="ui-time">0.00</div>
        </div>
        <div class="hud-group">
          <div class="hud-label">TIME</div>
          <div class="hud-label">GUNMAN</div>
        </div>
        <div class="hud-group">
          <div class="hud-value" id="ui-limit">0.00</div>
        </div>
      </div>

      <canvas id="gameCanvas" width="256" height="224"></canvas>

      <div id="hud-bottom" class="hud-bar hud-bottom" style="display: none">
        <div class="hud-group" style="align-items: flex-start">
          <div class="hud-value" style="color: #adff2f">
            $<span id="ui-reward">0</span>
          </div>
          <div style="font-size: 8px">REWARD</div>
        </div>
        <div class="hud-group">
          <div class="hud-value" id="ui-score">000000</div>
          <div style="font-size: 8px">SCORE</div>
        </div>
        <div class="hud-group" style="align-items: flex-end">
          <div class="hud-value" id="ui-level">1</div>
          <div style="font-size: 8px" id="ui-level-label">LEVEL</div>
        </div>
      </div>

      <!-- MENU -->
      <div id="start-screen" class="ui-layer">
        <div class="logo-main">YOUNG<br />GUNS</div>

        <div class="menu-container">
          <div
            class="menu-row"
            onclick="startGame('A')"
            ontouchstart="startGame('A')"
          >
            <div class="menu-label">GAME A</div>
            <div class="menu-desc">1 OUTLAW</div>
          </div>
          <div
            class="menu-row"
            onclick="startGame('B')"
            ontouchstart="startGame('B')"
          >
            <div class="menu-label">GAME B</div>
            <div class="menu-desc">2 OUTLAWS</div>
          </div>
          <div
            class="menu-row"
            onclick="startGame('C')"
            ontouchstart="startGame('C')"
          >
            <div class="menu-label">GAME C</div>
            <div class="menu-desc">GANG</div>
          </div>
        </div>

        <div class="footer-info">
          <div style="color: white; margin-bottom: 10px">TOP SCORE - 12000</div>
          <div class="copyright">©1988 YOUNG GUNS CO.</div>
          <div class="copyright">MADE BY JOHAN LINDELL</div>
        </div>
      </div>

      <!-- MEDDELANDEN -->
      <div id="message-overlay">
        <div id="game-msg" class="big-msg">FIRE!</div>
      </div>

      <div id="flash-effect" class="ui-layer flash"></div>
    </div>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");

      // Spelvariabler
      let gameState = "MENU";
      let gameMode = "A";
      let level = 1;
      let score = 0;
      let reward = 500;

      let waitTimer = 0;
      let drawTimer = 0;
      let reactionLimit = 1000;
      let enemies = [];
      let playerReactionTime = 0;

      let inputLockTimer = 0;

      // --- AUDIO ---
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      function playSound(type) {
        if (audioCtx.state === "suspended") audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const t = audioCtx.currentTime;

        if (type === "fire") {
          osc.type = "square";
          osc.frequency.setValueAtTime(150, t);
          osc.frequency.exponentialRampToValueAtTime(40, t + 0.1);
          gain.gain.setValueAtTime(0.3, t);
          gain.gain.linearRampToValueAtTime(0, t + 0.1);
          osc.start();
          osc.stop(t + 0.1);
        } else if (type === "cue") {
          osc.type = "triangle";
          osc.frequency.setValueAtTime(880, t);
          gain.gain.setValueAtTime(0.1, t);
          gain.gain.linearRampToValueAtTime(0, t + 0.1);
          osc.start();
          osc.stop(t + 0.1);
        } else if (type === "shot") {
          osc.type = "sawtooth";
          osc.frequency.setValueAtTime(1200, t);
          osc.frequency.exponentialRampToValueAtTime(100, t + 0.15);
          gain.gain.setValueAtTime(0.4, t);
          gain.gain.linearRampToValueAtTime(0, t + 0.15);
          osc.start();
          osc.stop(t + 0.15);
        } else if (type === "win") {
          osc.type = "square";
          osc.frequency.setValueAtTime(523, t);
          osc.frequency.setValueAtTime(659, t + 0.08);
          osc.frequency.setValueAtTime(784, t + 0.16);
          osc.frequency.setValueAtTime(1046, t + 0.24);
          gain.gain.value = 0.1;
          osc.start();
          osc.stop(t + 0.4);
        }
      }

      // --- ENTITIES ---
      function createEnemy(type, startX, targetX) {
        // 0: Billy the Kid (Standard)
        // 1: Doc Scurlock (Slim)
        // 2: Chavez (Native/Vest)
        // 3: Dick Brewer (Boss/Leader)
        // 4: Dirty Steve (Short/Dirty)
        // 5: Charlie Bowdre (Standard/Bowler)
        return {
          type: type,
          x: startX,
          y: 110, // Default för Game A/B
          w: 24,
          h: 48,
          targetX: targetX,
          frame: 0,
          state: "WALK",
          timer: 0,
          scale: 1.0, // För animation
        };
      }

      // --- LOGIK ---
      function startGame(mode) {
        if (gameState !== "MENU") return;

        gameMode = mode;
        gameState = "WALK_IN";
        score = 0;
        level = 1;
        reward = 500;

        document.getElementById("start-screen").style.display = "none";
        document.getElementById("hud-top").style.display = "flex";
        document.getElementById("hud-bottom").style.display = "flex";

        document.getElementById("ui-level-label").innerText =
          mode === "C" ? "WAVE" : "LEVEL";

        if (audioCtx.state === "suspended") audioCtx.resume();

        resetRound();
      }

      function resetRound() {
        gameState = "WALK_IN";
        document.getElementById("message-overlay").style.display = "none";
        playerReactionTime = 0;
        updateUI();

        inputLockTimer = Date.now() + 500;

        enemies = [];

        let baseReaction = 1000 - level * 50;
        if (baseReaction < 400) baseReaction = 400;
        reactionLimit = baseReaction;

        if (gameMode === "A") {
          const type = Math.floor(Math.random() * 6); // 0-5
          enemies.push(createEnemy(type, -30, 116));
        } else if (gameMode === "B") {
          reactionLimit += 200;
          const type1 = Math.floor(Math.random() * 6);
          const type2 = Math.floor(Math.random() * 6);
          enemies.push(createEnemy(type1, -30, 70));
          enemies.push(createEnemy(type2, 280, 160));
        } else if (gameMode === "C") {
          gameState = "WAVE_INTRO";

          const msg = document.getElementById("game-msg");
          msg.innerText = "WAVE " + level;
          msg.style.color = "#adff2f";
          msg.style.borderColor = "#adff2f";
          document.getElementById("message-overlay").style.display = "block";

          setTimeout(() => {
            if (gameState === "WAVE_INTRO") {
              document.getElementById("message-overlay").style.display = "none";
              startWaveC();
            }
          }, 1500);
        }
      }

      function startWaveC() {
        gameState = "WALK_IN";

        reactionLimit = Math.max(400, 1200 - level * 40);

        let count = 1;
        if (level >= 20) count = 2;
        else if (level > 5 && Math.random() > 0.4) count = 2;
        else if (Math.random() > 0.7) count = 2;

        const positions = [
          { x: 45, y: 45 }, // Fönster V Uppe
          { x: 180, y: 45 }, // Fönster H Uppe
          { x: 45, y: 115 }, // Fönster V Nere
          { x: 180, y: 115 }, // Fönster H Nere
          { x: 116, y: 115 }, // Dörr
        ];

        positions.sort(() => Math.random() - 0.5);

        for (let i = 0; i < count; i++) {
          const pos = positions[i];
          const type = Math.floor(Math.random() * 6); // 0-5
          let e = createEnemy(type, pos.x, pos.x);
          e.y = pos.y;
          e.state = "IDLE";
          e.scale = 0;
          enemies.push(e);
        }
      }

      function update() {
        const now = Date.now();

        if (gameState === "WAVE_INTRO") return;

        if (gameMode === "C") {
          enemies.forEach((e) => {
            if (e.state === "DEAD") {
              if (e.scale > 0) {
                e.scale -= 0.05;
                if (e.scale < 0) e.scale = 0;
              }
            }
          });
        }

        if (gameState === "WALK_IN") {
          let allArrived = true;

          if (gameMode === "C") {
            enemies.forEach((e) => {
              if (e.scale < 1.0) {
                e.scale += 0.05;
                if (e.scale > 1.0) e.scale = 1.0;
                allArrived = false;
              }
            });
          } else {
            enemies.forEach((e) => {
              if (Math.abs(e.x - e.targetX) > 1.5) {
                e.x += e.x < e.targetX ? 1.5 : -1.5;
                allArrived = false;
                if (now % 200 > 100) e.frame = 1;
                else e.frame = 0;
              } else {
                e.frame = 0;
                e.state = "IDLE";
              }
            });
          }

          if (allArrived) {
            gameState = "WAIT";
            let waitBase = 1000;
            let waitVar = 2000;
            if (gameMode === "C") {
              waitBase = Math.max(200, 1000 - level * 30);
              waitVar = Math.max(500, 1500 - level * 20);
            }
            waitTimer = now + (Math.random() * waitVar + waitBase);
          }
        } else if (gameState === "WAIT") {
          if (now > waitTimer) {
            gameState = "DRAW";
            drawTimer = now;
            playSound("cue");
            const msg = document.getElementById("game-msg");
            msg.innerText = "FIRE!";
            msg.style.color = "#d85040";
            msg.style.borderColor = "#d85040";
            document.getElementById("message-overlay").style.display = "block";
          }
        } else if (gameState === "DRAW") {
          let elapsed = now - drawTimer;
          document.getElementById("ui-time").innerText = (
            elapsed / 1000
          ).toFixed(2);

          let livingEnemies = enemies.filter((e) => e.state !== "DEAD");
          if (livingEnemies.length > 0 && elapsed > reactionLimit) {
            playerLost();
          }
        }
      }

      function handleInput(x, y) {
        if (Date.now() < inputLockTimer) return;

        if (gameState === "WALK_IN" || gameState === "WAVE_INTRO") return;

        if (gameState === "WAIT") {
          gameState = "END";
          const msg = document.getElementById("game-msg");
          msg.innerText = "FOUL!";
          msg.style.color = "#d8ac50";
          msg.style.borderColor = "#d8ac50";
          document.getElementById("message-overlay").style.display = "block";
          playSound("fire");
          setTimeout(() => {
            resetRound();
          }, 2000);
          return;
        }

        if (gameState === "DRAW") {
          playSound("shot");
          flashScreen();

          let hitAny = false;
          enemies.forEach((e) => {
            if (e.state !== "DEAD") {
              if (
                x >= e.x - 15 &&
                x <= e.x + e.w + 15 &&
                y >= e.y - 25 &&
                y <= e.y + e.h + 25
              ) {
                e.state = "DEAD";
                hitAny = true;
              }
            }
          });

          if (enemies.every((e) => e.state === "DEAD")) {
            playerReactionTime = Date.now() - drawTimer;
            playerWon();
          }
        }
      }

      function playerWon() {
        gameState = "END";
        playSound("win");
        document.getElementById("message-overlay").style.display = "none";

        let points = Math.max(100, 2000 - playerReactionTime);
        score += points;
        reward += 100;
        level++;
        updateUI();

        setTimeout(resetRound, 3000);
      }

      function playerLost() {
        gameState = "END";
        playSound("fire");
        enemies.forEach((e) => {
          if (e.state !== "DEAD") e.state = "FIRE";
        });

        const msg = document.getElementById("game-msg");
        msg.innerText = "YOU LOST";
        msg.style.color = "white";
        msg.style.borderColor = "white";
        document.getElementById("message-overlay").style.display = "block";

        setTimeout(() => {
          document.getElementById("start-screen").style.display = "flex";
          document.getElementById("hud-top").style.display = "none";
          document.getElementById("hud-bottom").style.display = "none";
          document.getElementById("message-overlay").style.display = "none";
          gameState = "MENU";
        }, 3000);
      }

      function updateUI() {
        document.getElementById("ui-score").innerText = score
          .toString()
          .padStart(6, "0");
        document.getElementById("ui-reward").innerText = reward;
        document.getElementById("ui-level").innerText = level;
        document.getElementById("ui-limit").innerText = (
          reactionLimit / 1000
        ).toFixed(2);
      }

      function flashScreen() {
        const el = document.getElementById("flash-effect");
        el.style.opacity = 0.8;
        setTimeout(() => (el.style.opacity = 0), 50);
      }

      // --- RITNING ---
      function draw() {
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (gameMode === "C") {
          drawSaloon();
        } else {
          drawDesert();
        }

        enemies.forEach((e) => drawEnemy(e));
      }

      function drawDesert() {
        ctx.fillStyle = "#202090";
        ctx.fillRect(0, 0, canvas.width, 140);
        ctx.fillStyle = "#a88440";
        ctx.fillRect(0, 140, canvas.width, 84);
        drawScenery();
      }

      function drawSaloon() {
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#e08070";
        ctx.fillRect(10, 10, 236, 204);
        ctx.fillStyle = "#b05040";
        for (let y = 20; y < 214; y += 10) {
          ctx.fillRect(10, y, 236, 1);
        }
        ctx.fillStyle = "#000";
        ctx.fillRect(40, 40, 34, 58);
        ctx.fillRect(175, 40, 34, 58);
        ctx.fillRect(40, 110, 34, 58);
        ctx.fillRect(175, 110, 34, 58);
        ctx.fillRect(108, 110, 40, 104);
        ctx.fillStyle = "#603010";
        ctx.fillRect(90, 70, 76, 20);
        ctx.fillStyle = "#fff";
        ctx.font = "8px 'Press Start 2P'";

        // DYNAMISK TEXT (Game C Progress)
        let signText = "SALOON";
        if (
          gameMode === "C" &&
          gameState === "END" &&
          enemies.every((e) => e.state === "DEAD")
        ) {
          const completedWave = level - 1;
          if (completedWave >= 20) signText = "MASTER";
          else if (completedWave >= 10) signText = "NICE";
          else signText = "GOOD";
        }

        const textWidth = ctx.measureText(signText).width;
        const xPos = 90 + (76 - textWidth) / 2;
        ctx.fillText(signText, xPos, 84);
      }

      function drawScenery() {
        ctx.fillStyle = "#603030";
        ctx.beginPath();
        ctx.moveTo(20, 140);
        ctx.lineTo(60, 60);
        ctx.lineTo(100, 140);
        ctx.fill();
        drawCactus(110, 130, 1);
        drawCactus(220, 135, 0.8);
      }

      function drawCactus(x, y, s) {
        ctx.fillStyle = "#389030";
        const w = Math.floor(6 * s);
        const h = Math.floor(25 * s);
        ctx.fillRect(x, y - h, w, h);
        ctx.fillRect(x - w, y - h / 2, w, w);
        ctx.fillRect(x - w, y - h / 1.5, 2, w * 2);
        ctx.fillRect(x + w, y - h / 2.5, w, w);
        ctx.fillRect(x + w * 1.5, y - h / 1.8, 2, w * 2);
      }

      function drawEnemy(e) {
        ctx.save();
        ctx.translate(Math.floor(e.x), Math.floor(e.y));

        if (gameMode === "C") {
          if (e.scale !== 1.0) {
            ctx.translate(12, 24);
            ctx.scale(e.scale, e.scale);
            ctx.translate(-12, -24);
          }
        } else if (e.state === "DEAD") {
          ctx.rotate(Math.PI / 2);
          ctx.translate(0, -16);
        }

        let shadow = gameMode === "C" && (e.state === "DEAD" || e.scale < 0.9);

        if (e.type === 0) drawBilly(e, shadow);
        else if (e.type === 1) drawDoc(e, shadow);
        else if (e.type === 2) drawChavez(e, shadow);
        else if (e.type === 3) drawDick(e, shadow);
        else if (e.type === 4) drawSteve(e, shadow);
        else if (e.type === 5) drawCharlie(e, shadow);

        ctx.restore();
      }

      // --- YOUNG GUNS CHARACTERS ---

      function drawBilly(e, shadow) {
        // Billy the Kid: Standard look
        let cSkin = shadow ? "#805030" : "#f8b880";
        let cVest = shadow ? "#500000" : "#a00000"; // Red vest
        let cPants = shadow ? "#101060" : "#3030b0";
        let cHat = shadow ? "#808080" : "#d0d0d0";
        let cShirt = shadow ? "#808080" : "#fff";

        drawGeneric(e, cSkin, cVest, cPants, cHat, cShirt);
      }

      function drawDoc(e, shadow) {
        // Doc Scurlock: Slim, black coat
        let cSkin = shadow ? "#805030" : "#f0b080";
        let cVest = shadow ? "#101010" : "#202020"; // Dark Coat
        let cPants = shadow ? "#101010" : "#202020";
        let cHat = shadow ? "#202020" : "#404040"; // Black hat
        let cShirt = shadow ? "#606060" : "#a0a0a0"; // Grey shirt

        drawSlimModel(e, cSkin, cVest, cPants, cHat, cShirt);
      }

      function drawChavez(e, shadow) {
        // Chavez: Native look, earth tones
        let cSkin = shadow ? "#805030" : "#d09060"; // Darker skin
        let cVest = shadow ? "#402010" : "#804020"; // Leather vest
        let cPants = shadow ? "#202020" : "#404040";
        let cHat = shadow ? "#302010" : "#604020"; // Brown hat
        let cShirt = shadow ? "#502020" : "#a04040"; // Red shirt

        drawGeneric(e, cSkin, cVest, cPants, cHat, cShirt);
      }

      function drawDick(e, shadow) {
        // Dick Brewer: Leader, "Boss" model
        let cSkin = shadow ? "#805030" : "#f8b880";
        let cSuit = shadow ? "#202040" : "#404080"; // Blueish coat
        let cTie = shadow ? "#400000" : "#800000";
        let cHat = shadow ? "#202020" : "#404040";
        let cShirt = shadow ? "#505050" : "#fff";

        drawBossModel(e, cSkin, cSuit, cTie, cHat, cShirt, shadow);
      }

      function drawSteve(e, shadow) {
        // Dirty Steve: Scruffy, Short model
        let cSkin = shadow ? "#806040" : "#e0b090"; // Unshaven skin tone
        let cVest = shadow ? "#303020" : "#606040"; // Dirty vest
        let cPants = shadow ? "#201000" : "#503010"; // Brown pants
        let cHat = shadow ? "#201000" : "#402010"; // Old hat
        let cShirt = shadow ? "#505040" : "#a0a090"; // Dirty shirt

        drawShortModel(e, cSkin, cVest, cPants, cHat, cShirt);
      }

      function drawCharlie(e, shadow) {
        // Charlie Bowdre: Bowler hat
        let cSkin = shadow ? "#805030" : "#f8b880";
        let cVest = shadow ? "#202020" : "#404040"; // Grey vest
        let cPants = shadow ? "#303030" : "#606060";
        let cHat = shadow ? "#101010" : "#202020"; // Black Bowler
        let cShirt = shadow ? "#707070" : "#e0e0e0";

        // Customized hat for Charlie
        drawGeneric(e, cSkin, cVest, cPants, cHat, cShirt, true);
      }

      // --- DRAWING HELPERS ---

      function drawGeneric(
        e,
        cSkin,
        cVest,
        cPants,
        cHat,
        cShirt,
        isBowler = false
      ) {
        if (e.state === "WALK") {
          const facingRight = e.targetX > e.x;
          if (!facingRight) {
            ctx.translate(24, 0);
            ctx.scale(-1, 1);
          }
          ctx.fillStyle = cPants;
          if (e.frame === 0) {
            ctx.fillRect(8, 30, 6, 18);
            ctx.fillRect(2, 28, 6, 16);
          } else {
            ctx.fillRect(6, 30, 6, 18);
            ctx.fillRect(14, 28, 6, 16);
          }
          ctx.fillStyle = cShirt;
          ctx.fillRect(8, 12, 10, 18);
          ctx.fillStyle = cVest;
          ctx.fillRect(8, 12, 6, 18);
          ctx.fillStyle = cSkin;
          ctx.fillRect(8, 2, 9, 10);

          ctx.fillStyle = cHat;
          if (isBowler) {
            ctx.fillRect(6, 0, 12, 2);
            ctx.fillRect(8, -4, 8, 4);
          } else {
            ctx.fillRect(4, 0, 16, 2);
            ctx.fillRect(8, -4, 10, 4);
          }

          ctx.fillStyle = cShirt;
          if (e.frame === 0) ctx.fillRect(10, 14, 4, 14);
          else ctx.fillRect(12, 12, 4, 14);
        } else {
          ctx.fillStyle = cPants;
          ctx.fillRect(4, 30, 6, 18);
          ctx.fillRect(14, 30, 6, 18);
          ctx.fillStyle = cShirt;
          ctx.fillRect(4, 12, 16, 18);
          ctx.fillStyle = cVest;
          ctx.fillRect(4, 12, 4, 18);
          ctx.fillRect(16, 12, 4, 18);
          ctx.fillStyle = cSkin;
          ctx.fillRect(7, 2, 10, 10);

          ctx.fillStyle = "#000";
          if (e.state === "DEAD") {
            ctx.fillRect(8, 5, 2, 1);
            ctx.fillRect(13, 5, 2, 1);
            ctx.fillRect(9, 9, 5, 2);
          } else {
            ctx.fillRect(8, 4, 2, 2);
            ctx.fillRect(13, 4, 2, 2);
            ctx.fillRect(9, 9, 5, 1);
          }

          ctx.fillStyle = cHat;
          if (isBowler) {
            ctx.fillRect(4, 0, 16, 2);
            ctx.fillRect(6, -4, 12, 4);
          } else {
            ctx.fillRect(2, 0, 20, 2);
            ctx.fillRect(6, -4, 12, 4);
          }

          if (e.state === "FIRE") {
            ctx.fillStyle = cShirt;
            ctx.fillRect(20, 12, 8, 4);
            ctx.fillStyle = "#000";
            ctx.fillRect(28, 10, 6, 4);
            if (Math.random() > 0.5) {
              ctx.fillStyle = "#ff0";
              ctx.fillRect(34, 9, 6, 6);
            }
          } else {
            ctx.fillStyle = cShirt;
            ctx.fillRect(0, 12, 4, 14);
            ctx.fillRect(20, 12, 4, 14);
          }
        }
      }

      function drawSlimModel(e, cSkin, cVest, cPants, cHat, cShirt) {
        if (e.state === "WALK") {
          const facingRight = e.targetX > e.x;
          if (!facingRight) {
            ctx.translate(24, 0);
            ctx.scale(-1, 1);
          }
          ctx.fillStyle = cPants;
          if (e.frame === 0) {
            ctx.fillRect(8, 28, 4, 20);
            ctx.fillRect(4, 26, 4, 18);
          } else {
            ctx.fillRect(6, 28, 4, 20);
            ctx.fillRect(12, 26, 4, 18);
          }
          ctx.fillStyle = cShirt;
          ctx.fillRect(8, 8, 8, 20);
          ctx.fillStyle = cVest;
          ctx.fillRect(8, 8, 4, 20);
          ctx.fillStyle = cSkin;
          ctx.fillRect(8, -2, 8, 10);
          ctx.fillStyle = cHat;
          ctx.fillRect(4, -4, 16, 2);
          ctx.fillRect(8, -8, 8, 4);
          ctx.fillStyle = cShirt;
          if (e.frame === 0) ctx.fillRect(10, 10, 2, 16);
          else ctx.fillRect(12, 8, 2, 16);
        } else {
          ctx.fillStyle = cPants;
          ctx.fillRect(6, 28, 4, 20);
          ctx.fillRect(14, 28, 4, 20);
          ctx.fillStyle = cShirt;
          ctx.fillRect(6, 8, 12, 20);
          ctx.fillStyle = cVest;
          ctx.fillRect(6, 8, 4, 20);
          ctx.fillRect(14, 8, 4, 20);
          ctx.fillStyle = cSkin;
          ctx.fillRect(8, -2, 8, 10);
          ctx.fillStyle = "#000";
          if (e.state === "DEAD") {
            ctx.fillRect(9, 0, 2, 1);
            ctx.fillRect(13, 0, 2, 1);
          } else {
            ctx.fillRect(9, 0, 2, 2);
            ctx.fillRect(13, 0, 2, 2);
          }
          ctx.fillStyle = cHat;
          ctx.fillRect(4, -4, 16, 2);
          ctx.fillRect(8, -8, 8, 4);
          if (e.state === "FIRE") {
            ctx.fillStyle = cShirt;
            ctx.fillRect(18, 10, 8, 4);
            ctx.fillStyle = "#000";
            ctx.fillRect(26, 8, 6, 4);
            if (Math.random() > 0.5) {
              ctx.fillStyle = "#ff0";
              ctx.fillRect(32, 7, 6, 6);
            }
          } else {
            ctx.fillStyle = cShirt;
            ctx.fillRect(2, 10, 4, 16);
            ctx.fillRect(18, 10, 4, 16);
          }
        }
      }

      function drawShortModel(e, cSkin, cVest, cPants, cHat, cShirt) {
        if (e.state === "WALK") {
          const facingRight = e.targetX > e.x;
          if (!facingRight) {
            ctx.translate(24, 0);
            ctx.scale(-1, 1);
          }
          ctx.fillStyle = cPants;
          if (e.frame === 0) {
            ctx.fillRect(6, 38, 6, 10);
            ctx.fillRect(0, 36, 6, 10);
          } else {
            ctx.fillRect(4, 38, 6, 10);
            ctx.fillRect(12, 36, 6, 10);
          }
          ctx.fillStyle = cShirt;
          ctx.fillRect(4, 18, 14, 20);
          ctx.fillStyle = cVest;
          ctx.fillRect(4, 18, 8, 20);
          ctx.fillStyle = cSkin;
          ctx.fillRect(6, 8, 10, 10);
          ctx.fillStyle = cHat;
          ctx.fillRect(0, 6, 20, 2);
          ctx.fillRect(4, 2, 14, 4);
          ctx.fillStyle = cShirt;
          ctx.fillRect(8, 22, 4, 10);
        } else {
          ctx.fillStyle = cPants;
          ctx.fillRect(2, 38, 8, 10);
          ctx.fillRect(14, 38, 8, 10);
          ctx.fillStyle = cShirt;
          ctx.fillRect(2, 18, 20, 20);
          ctx.fillStyle = cVest;
          ctx.fillRect(2, 18, 6, 20);
          ctx.fillRect(16, 18, 6, 20);
          ctx.fillStyle = cSkin;
          ctx.fillRect(7, 8, 10, 10);
          ctx.fillStyle = "#000";
          ctx.fillRect(8, 15, 8, 2); // Skägg
          if (e.state !== "DEAD") {
            ctx.fillRect(8, 10, 2, 2);
            ctx.fillRect(14, 10, 2, 2);
          } else {
            ctx.fillRect(8, 11, 2, 1);
            ctx.fillRect(14, 11, 2, 1);
          }
          ctx.fillStyle = cHat;
          ctx.fillRect(0, 6, 24, 2);
          ctx.fillRect(4, 2, 16, 4);
          if (e.state === "FIRE") {
            ctx.fillStyle = cShirt;
            ctx.fillRect(22, 22, 6, 4);
            ctx.fillStyle = "#000";
            ctx.fillRect(28, 20, 6, 4);
            if (Math.random() > 0.5) {
              ctx.fillStyle = "#ff0";
              ctx.fillRect(34, 19, 6, 6);
            }
          } else {
            ctx.fillStyle = cShirt;
            ctx.fillRect(-2, 22, 4, 12);
            ctx.fillRect(22, 22, 4, 12);
          }
        }
      }

      function drawBossModel(e, cSkin, cSuit, cTie, cHat, cShirt, shadow) {
        if (e.state === "WALK") {
          const facingRight = e.targetX > e.x;
          if (!facingRight) {
            ctx.translate(24, 0);
            ctx.scale(-1, 1);
          }
          ctx.fillStyle = cSuit;
          if (e.frame === 0) {
            ctx.fillRect(8, 30, 6, 18);
            ctx.fillRect(2, 28, 6, 16);
          } else {
            ctx.fillRect(6, 30, 6, 18);
            ctx.fillRect(14, 28, 6, 16);
          }
          ctx.fillRect(6, 12, 12, 20);
          ctx.fillStyle = cShirt;
          ctx.fillRect(12, 12, 2, 10);
          ctx.fillStyle = cSkin;
          ctx.fillRect(8, 2, 9, 10);
          ctx.fillStyle = cHat;
          ctx.fillRect(4, 0, 16, 2);
          ctx.fillRect(8, -4, 10, 4);
          ctx.fillStyle = cSuit;
          if (e.frame === 0) ctx.fillRect(10, 14, 4, 14);
          else ctx.fillRect(12, 12, 4, 14);
        } else {
          ctx.fillStyle = cSuit;
          ctx.fillRect(4, 30, 6, 18);
          ctx.fillRect(14, 30, 6, 18);
          ctx.fillRect(2, 12, 20, 20);
          ctx.fillStyle = cShirt;
          ctx.fillRect(10, 12, 4, 20);
          ctx.fillStyle = cTie;
          ctx.fillRect(11, 14, 2, 10);
          ctx.fillStyle = cSkin;
          ctx.fillRect(7, 2, 10, 10);
          ctx.fillStyle = "#000";
          ctx.fillRect(9, 9, 6, 1);
          if (e.state === "DEAD") {
            ctx.fillRect(8, 5, 2, 1);
            ctx.fillRect(13, 5, 2, 1);
          } else {
            ctx.fillRect(8, 4, 2, 2);
            ctx.fillRect(13, 4, 2, 2);
          }
          ctx.fillStyle = cHat;
          ctx.fillRect(2, 0, 20, 2);
          ctx.fillRect(6, -4, 12, 4);
          if (e.state === "FIRE") {
            ctx.fillStyle = cSuit;
            ctx.fillRect(20, 12, 8, 4);
            ctx.fillStyle = "#000";
            ctx.fillRect(28, 10, 6, 4);
            if (Math.random() > 0.5) {
              ctx.fillStyle = "#ff0";
              ctx.fillRect(34, 9, 6, 6);
            }
          } else {
            ctx.fillStyle = cSuit;
            ctx.fillRect(0, 12, 4, 14);
            ctx.fillRect(20, 12, 4, 14);
          }
        }
      }

      function loop() {
        if (gameState !== "MENU") {
          update();
          draw();
        }
        requestAnimationFrame(loop);
      }
      loop();

      function onInteract(e) {
        if (gameState !== "MENU" && gameState !== "END") {
          e.preventDefault();

          const rect = canvas.getBoundingClientRect();

          let clientX, clientY;
          if (e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
          } else {
            clientX = e.clientX;
            clientY = e.clientY;
          }

          const scaleX = canvas.width / rect.width;
          const scaleY = canvas.height / rect.height;

          const x = (clientX - rect.left) * scaleX;
          const y = (clientY - rect.top) * scaleY;

          handleInput(x, y);
        }
      }

      canvas.addEventListener("mousedown", onInteract);
      canvas.addEventListener("touchstart", onInteract, { passive: false });
    </script>
  </body>
</html>
